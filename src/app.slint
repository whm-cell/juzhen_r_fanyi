// JSONç¿»è¯‘å·¥å…·ä¸»çª—å£ï¼šä¸‰åˆ†æ å¸ƒå±€ï¼ˆæ ‘è§†å›¾ã€é¢„è§ˆåŒºã€ç²˜è´´åŒºï¼‰
// éµå¾ªxqwnéœ€æ±‚ï¼šæ”¯æŒå¤§æ–‡ä»¶JSONæ ‘å¯¼èˆªã€èŠ‚ç‚¹æå–ã€ç²¾ç¡®å›å†™

import { Button, ScrollView, ListView, TextEdit, ProgressIndicator } from "std-widgets.slint";

// æ ‘èŠ‚ç‚¹æ•°æ®ç»“æ„ï¼ˆä¸Rust shadow_tree::JsonTreeNodeå¯¹åº”ï¼‰
struct TreeNodeData {
    name: string,           // èŠ‚ç‚¹åç§°ï¼ˆå­—æ®µåæˆ–æ•°ç»„ç´¢å¼•ï¼‰
    path: string,           // JSONPathè·¯å¾„
    kind: string,           // èŠ‚ç‚¹ç±»å‹ï¼šObject/Array/String/Number/Bool/Null
    children: int,          // å­èŠ‚ç‚¹æ•°é‡
    preview: string,        // èŠ‚ç‚¹é¢„è§ˆæ–‡æœ¬
    depth: int,             // èŠ‚ç‚¹æ·±åº¦ï¼ˆç”¨äºç¼©è¿›æ˜¾ç¤ºï¼‰
    expanded: bool,         // æ˜¯å¦å±•å¼€ï¼ˆç”¨äºæŠ˜å /å±•å¼€åŠŸèƒ½ï¼‰
    visible: bool,          // æ˜¯å¦å¯è§ï¼ˆä¿ç•™å­—æ®µï¼Œä½†åœ¨Rustç«¯è¿‡æ»¤ï¼‰
}

// æœç´¢ç»“æœåˆ—è¡¨é¡¹ï¼ˆç”¨äºä¸­é—´é¢æ¿ï¼šåˆ—è¡¨+å•æ¡è¯¦æƒ…ï¼‰
struct SearchItemData {
    name: string,
    path: string,
    kind: string,
}

// ç»ˆç«¯é£æ ¼æŒ‰é’®ç»„ä»¶
component TerminalButton inherits Rectangle {
    in property<string> text;
    in property<bool> enabled: true;
    callback clicked;

    height: 32px;
    background: transparent;
    border-width: 0px;

    touch_area := TouchArea {
        enabled: root.enabled;
        clicked => { root.clicked(); }
    }

    Text {
        text: "[ " + root.text + " ]";
        font-family: "JetBrains Mono";
        font-size: 13px;
        color: root.enabled ? (touch_area.has_hover ? #39FF14 : #C9D1D9) : #6E7681;
        vertical-alignment: center;
        horizontal-alignment: center;
    }
}


export component AppWindow inherits Window {
    title: "JSON ç¿»è¯‘å·¥å…·";
    in property<[SearchItemData]> search_results: [];          // æœç´¢ç»“æœï¼ˆä»…å…ƒæ•°æ®åˆ—è¡¨ï¼‰

    width: 1400px;          // è¿›ä¸€æ­¥å¢åŠ å®½åº¦ä»¥ç¡®ä¿å³ä¾§åŒºåŸŸå®Œæ•´æ˜¾ç¤º
    height: 1000px;         // è¿›ä¸€æ­¥å¢åŠ é«˜åº¦ä»¥ç¡®ä¿æ‰€æœ‰å†…å®¹å®Œæ•´æ˜¾ç¤º
    background: background_primary;

    // === çŠ¶æ€å±æ€§ ===
    in property<string> current_path: "";                    // å½“å‰æ‰“å¼€çš„æ–‡ä»¶è·¯å¾„
    in property<[TreeNodeData]> tree_model: [];              // æ ‘è§†å›¾æ•°æ®æ¨¡å‹
    in property<string> preview_text: "";                    // é¢„è§ˆåŒºæ–‡æœ¬ï¼ˆä¸­é—´äº§ç‰© ç¬¬äºŒé˜¶æ®µï¼‰
    in-out property<string> paste_text: "";                  // ç²˜è´´åŒºæ–‡æœ¬
    in property<string> selected_json_path: "";              // å½“å‰é€‰ä¸­èŠ‚ç‚¹çš„JSONPath/é˜¶æ®µæç¤º
    in property<string> status_message: "å°±ç»ª";              // çŠ¶æ€æ æ¶ˆæ¯
    in property<string> performance_info: "";               // æ€§èƒ½ä¿¡æ¯
    in-out property<string> search_filter: "";              // æœç´¢è¿‡æ»¤æ–‡æœ¬
    in-out property<string> final_product_text: "";          // æœ€ç»ˆäº§ç‰©æ–‡æœ¬ï¼ˆç¬¬ä¸‰é˜¶æ®µï¼‰

    // === åˆ†é¡µç›¸å…³å±æ€§ ===
    in property<int> preview_current_page: 1;               // ä¸­é—´äº§ç‰©å½“å‰é¡µç 
    in property<int> preview_total_pages: 1;                // ä¸­é—´äº§ç‰©æ€»é¡µæ•°
    in property<int> final_current_page: 1;                 // æœ€ç»ˆäº§ç‰©å½“å‰é¡µç 
    in property<int> final_total_pages: 1;                  // æœ€ç»ˆäº§ç‰©æ€»é¡µæ•°

    // === è¿›åº¦æ¡å±æ€§ ===
    in-out property<float> progress_value: 0.0;             // è¿›åº¦å€¼ (0.0-1.0)
    in-out property<string> progress_text: "";              // è¿›åº¦æ–‡æœ¬
    in-out property<bool> progress_visible: false;          // è¿›åº¦æ¡æ˜¯å¦å¯è§

    // === å›å†™æ—¥å¿—å±æ€§ ===
    in-out property<string> writeback_log: "";              // å›å†™è¿‡ç¨‹æ—¥å¿—

    // === å›è°ƒå‡½æ•° ===
    callback load_file();                                    // åŠ è½½æ–‡ä»¶
    callback node_selected(string);                         // èŠ‚ç‚¹è¢«é€‰ä¸­
    callback copy_pressed();                                 // å¤åˆ¶æŒ‰é’®
    callback write_back_pressed();                           // å›å†™æŒ‰é’®
    callback search_changed(string);                        // æœç´¢è¿‡æ»¤æ”¹å˜
    callback toggle_node_expanded(string);                  // åˆ‡æ¢èŠ‚ç‚¹å±•å¼€çŠ¶æ€
    callback one_click_final_product();                      // ä¸€é”®è·å¾—æœ€ç»ˆäº§ç‰©æŒ‰é’®
    callback search_item_selected(string);                  // åˆ—è¡¨é¡¹è¢«é€‰ä¸­ï¼ˆä¸­é—´äº§ç‰© ç¬¬ä¸€é˜¶æ®µï¼‰
    callback copy_all_pressed();                             // ç”Ÿæˆä¸­é—´äº§ç‰© ç¬¬äºŒé˜¶æ®µï¼ˆä¸å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼‰
    callback transform_pressed();                            // å°†ä¸­é—´äº§ç‰©2è½¬æ¢ä¸ºæœ€ç»ˆäº§ç‰©
    callback copy_final_pressed();                           // å¤åˆ¶æœ€ç»ˆäº§ç‰©åˆ°å‰ªè´´æ¿
    callback preview_page_changed(int);                      // ä¸­é—´äº§ç‰©åˆ†é¡µæ”¹å˜
    callback final_page_changed(int);                        // æœ€ç»ˆäº§ç‰©åˆ†é¡µæ”¹å˜
    callback upload_writeback_file();                        // ä¸Šä¼ å›å†™æ–‡ä»¶
    callback save_modified_json();                           // ä¿å­˜ä¿®æ”¹åçš„JSON
    callback clear_writeback_log();                          // æ¸…ç©ºå›å†™æ—¥å¿—

    // === è¿›åº¦æ¡æ§åˆ¶å‡½æ•° ===
    public function show_progress(text: string) {
        progress_text = text;
        progress_value = 0.0;
        progress_visible = true;
        debug("Slintå‡½æ•°: show_progress è¢«è°ƒç”¨, progress_visibleè®¾ä¸ºtrue");
    }

    public function update_progress(value: float, text: string) {
        progress_value = value;
        progress_text = text;
        debug("Slintå‡½æ•°: update_progress è¢«è°ƒç”¨, value=" + value);
    }

    public function hide_progress() {
        progress_visible = false;
        progress_value = 0.0;
        progress_text = "";
        debug("Slintå‡½æ•°: hide_progress è¢«è°ƒç”¨, progress_visibleè®¾ä¸ºfalse");
    }

    // === æµ‹è¯•å‡½æ•° ===
    public function test_progress() {
        debug("æµ‹è¯•å‡½æ•°: å¼€å§‹æµ‹è¯•è¿›åº¦æ¡");
        progress_visible = true;
        progress_text = "æµ‹è¯•è¿›åº¦æ¡";
        progress_value = 0.5;
        debug("æµ‹è¯•å‡½æ•°: progress_visible=" + (progress_visible ? "true" : "false") + ", text=" + progress_text);
    }

    // === å¸¸é‡å®šä¹‰ï¼ˆæ¶ˆé™¤é­”æ³•å€¼ï¼‰ ===
    property<length> header_height: 40px;
    property<length> status_height: 30px;
    property<length> button_height: 32px;
    property<length> panel_spacing: 8px;
    property<length> content_padding: 12px;

    // === ç»ˆç«¯é£æ ¼å­—ä½“ ===
    property<string> terminal_font: "JetBrains Mono";

    // === ç»ˆç«¯é£æ ¼æ·±è‰²ä¸»é¢˜ ===
    property<color> background_primary: #0D1117;      // æ·±é»‘ç»ˆç«¯èƒŒæ™¯
    property<color> background_secondary: #161B22;    // æ¬¡è¦ç»ˆç«¯èƒŒæ™¯
    property<color> background_tertiary: #21262D;     // ç¬¬ä¸‰ç»ˆç«¯èƒŒæ™¯
    property<color> accent_color: #39FF14;            // è§å…‰ç»¿é«˜äº®è‰²
    property<color> text_primary: #E6EDF3;            // ä¸»è¦æ–‡å­—ï¼ˆæ·¡é“¶è‰²ï¼‰
    property<color> text_secondary: #C9D1D9;          // æ¬¡è¦æ–‡å­—
    property<color> text_tertiary: #8B949E;           // ç¬¬ä¸‰çº§æ–‡å­—ï¼ˆæ€§èƒ½ä¿¡æ¯ï¼‰
    property<color> text_muted: #6E7681;              // é™éŸ³æ–‡å­—
    property<color> border_color: #30363D;            // è¾¹æ¡†é¢œè‰²
    property<color> button_primary: #39FF14;          // ä¸»æŒ‰é’®ï¼ˆè§å…‰ç»¿ï¼‰
    property<color> button_secondary: #30363D;        // æ¬¡æŒ‰é’®
    property<color> button_success: #39FF14;          // æˆåŠŸæŒ‰é’®
    property<color> button_danger: #F85149;           // å±é™©æŒ‰é’®
    property<color> hover_overlay: #30363D;           // æ‚¬åœè¦†ç›–

    VerticalLayout {
        spacing: 0;

        // === é¡¶éƒ¨å·¥å…·æ  ===
        Rectangle {
            height: 80px;  // å›ºå®šé«˜åº¦ä»¥å®¹çº³åŒè¡Œå¸ƒå±€
            background: background_secondary;
            border-width: 1px;
            border-color: border_color;

            VerticalLayout {
                padding: 8px;
                spacing: 6px;

                // ç¬¬ä¸€è¡Œï¼šæ–‡ä»¶æ“ä½œå’ŒçŠ¶æ€
                HorizontalLayout {
                    spacing: 12px;
                    alignment: space-between;

                    HorizontalLayout {
                        spacing: 12px;
                        alignment: start;

                        TerminalButton {
                            text: "æ‰“å¼€æ–‡ä»¶";
                            height: button_height;
                            clicked => { load_file(); }
                        }

                        TerminalButton {
                            text: "ä¸€é”®è·å¾—æœ€ç»ˆäº§ç‰©";
                            height: button_height;
                            enabled: current_path != "";
                            clicked => { one_click_final_product(); }
                        }

                        TerminalButton {
                            text: "å¤åˆ¶æœ€ç»ˆå‚æ‚Ÿ";
                            height: button_height;
                            enabled: final_product_text != "";
                            clicked => { copy_final_pressed(); }
                        }
                    }

                    Text {
                        text: current_path == "" ? "[ æœªæ‰“å¼€æ–‡ä»¶ ]" : "[ " + current_path + " ]";
                        font-size: 13px;
                        font-family: terminal_font;
                        color: current_path == "" ? text_muted : accent_color;
                        vertical-alignment: center;
                    }
                }

                // ç¬¬äºŒè¡Œï¼šæœç´¢åŠŸèƒ½
                HorizontalLayout {
                    spacing: 8px;
                    alignment: start;

                    Text {
                        text: "æœç´¢:";
                        font-size: 13px;
                        font-family: terminal_font;
                        color: accent_color;
                        vertical-alignment: center;
                        min-width: 40px;
                    }

                    Rectangle {
                        width: 200px;
                        height: 28px;
                        background: background_primary;
                        border-width: 1px;
                        border-color: search_filter == "" ? border_color : accent_color;
                        border-radius: 2px;

                        TextInput {
                            text <=> search_filter;
                            font-size: 12px;
                            font-family: terminal_font;
                            color: text_primary;
                            edited => { search_changed(self.text); }
                            single-line: true;
                        }
                    }

                    if search_filter != "": TouchArea {
                        width: 24px;
                        height: 24px;
                        clicked => {
                            search_filter = "";
                            search_changed("");
                        }

                        Rectangle {
                            background: clear_touch_area.has_hover ? hover_overlay : transparent;
                            border-radius: 2px;

                            Text {
                                text: "âœ•";
                                font-size: 12px;
                                font-family: terminal_font;
                                color: clear_touch_area.has_hover ? accent_color : text_muted;
                                vertical-alignment: center;
                                horizontal-alignment: center;
                            }

                            clear_touch_area := TouchArea {}
                        }
                    }
                }
            }
        }
        // === ä¸»å†…å®¹åŒºï¼šä¸‰åˆ†æ å¸ƒå±€ ===
        HorizontalLayout {
            spacing: panel_spacing;
            padding: content_padding;

            // === å·¦ä¾§ï¼šJSONæ ‘è§†å›¾ ===
            Rectangle {
                width: 25%;
                background: background_secondary;
                border-width: 1px;
                border-color: border_color;
                border-radius: 4px;

                // ä¼˜åŒ–ï¼šå¯ç”¨æ¸²æŸ“ç¼“å­˜ï¼Œå‡å°‘å¤§æ•°æ®é›†é‡ç»˜å¼€é”€
                cache-rendering-hint: true;

                VerticalLayout {
                    padding: content_padding;
                    spacing: panel_spacing;

                    Text {
                        text: "JSON ç»“æ„æ ‘";
                        font-size: 16px;
                        font-family: terminal_font;
                        font-weight: 600;
                        color: accent_color;
                    }

                    Rectangle {
                        height: 1px;
                        background: border_color;
                    }

                    ScrollView {
                        ListView {
                            for node in tree_model: Rectangle {
                                height: 24px;
                                background: touch_area.has_hover ? hover_overlay : transparent;
                                border-radius: 2px;

                                // ä¼˜åŒ–ï¼šä¸ºæ¯ä¸ªæ ‘èŠ‚ç‚¹å¯ç”¨æ¸²æŸ“ç¼“å­˜
                                cache-rendering-hint: true;

                                touch_area := TouchArea {
                                    clicked => {
                                        node_selected(node.path);
                                    }
                                }

                                HorizontalLayout {
                                    padding-left: 8px + (node.depth * 16px); // æ ¹æ®æ·±åº¦ç¼©è¿›
                                    padding-right: 8px;
                                    spacing: 4px;
                                    alignment: start;

                                    // å±•å¼€/æŠ˜å æŒ‰é’®
                                    if node.children > 0: expand_area := TouchArea {
                                        width: 20px;
                                        height: 20px;
                                        clicked => { toggle_node_expanded(node.path); }

                                        Rectangle {
                                            background: expand_area.has_hover ? hover_overlay : transparent;
                                            border-radius: 2px;

                                            Text {
                                                text: node.expanded ? "[-]" : "[+]";
                                                font-size: 11px;
                                                font-family: terminal_font;
                                                color: expand_area.has_hover ? accent_color : text_secondary;
                                                vertical-alignment: center;
                                                horizontal-alignment: center;
                                            }
                                        }
                                    }

                                    // å ä½ç¬¦ï¼ˆä¿æŒå¯¹é½ï¼‰
                                    if node.children == 0: Rectangle {
                                        width: 20px;
                                        height: 20px;
                                    }

                                    // èŠ‚ç‚¹ç±»å‹å›¾æ ‡
                                    Text {
                                        text: node.kind == "Object" ? "ğŸ“" :
                                              node.kind == "Array" ? "ğŸ“‹" :
                                              node.kind == "String" ? "ğŸ“" :
                                              node.kind == "Number" ? "ğŸ”¢" :
                                              node.kind == "Bool" ? "â˜‘ï¸" : "âšª";
                                        font-size: 12px;
                                        vertical-alignment: center;
                                    }

                                    // èŠ‚ç‚¹åç§°
                                    Text {
                                        text: node.name;
                                        font-size: 13px;
                                        font-family: terminal_font;
                                        vertical-alignment: center;
                                        color: selected_json_path == node.path ? accent_color : text_primary;
                                        font-weight: selected_json_path == node.path ? 600 : 400;
                                        min-width: 80px;
                                    }

                                    // åˆ†éš”ç¬¦
                                    Text {
                                        text: ":";
                                        font-size: 13px;
                                        font-family: terminal_font;
                                        color: text_muted;
                                        vertical-alignment: center;
                                    }

                                    // èŠ‚ç‚¹å€¼é¢„è§ˆ
                                    Text {
                                        text: node.preview;
                                        font-size: 12px;
                                        font-family: terminal_font;
                                        color: node.kind == "String" ? #98fb98 :  // æµ…ç»¿è‰²å­—ç¬¦ä¸²
                                               node.kind == "Number" ? #87ceeb :  // æµ…è“è‰²æ•°å­—
                                               node.kind == "Bool" ? #dda0dd :    // æµ…ç´«è‰²å¸ƒå°”å€¼
                                               text_secondary;
                                        vertical-alignment: center;
                                        overflow: elide;
                                    }

                                    // å­èŠ‚ç‚¹æ•°é‡æç¤º
                                    if node.children > 0: Text {
                                        text: "(" + node.children + ")";
                                        font-size: 11px;
                                        font-family: terminal_font;
                                        color: text_muted;
                                        vertical-alignment: center;
                                    }
                                }
                            }
                        }
                    }
                }
            }

            // === ä¸­é—´ï¼šé¢„è§ˆåŒº ===
            Rectangle {
                width: 30%;
                background: background_secondary;
                border-width: 1px;
                border-color: border_color;
                border-radius: 4px;

                VerticalLayout {
                    padding: content_padding;
                    spacing: panel_spacing;

                    HorizontalLayout {
                        spacing: panel_spacing;
                        alignment: space-between;

                        Text {
                            text: "èŠ‚ç‚¹é¢„è§ˆ";
                            font-size: 16px;
                            font-family: terminal_font;
                            font-weight: 600;
                            color: accent_color;
                        }


                    }

                    Rectangle { height: 1px; background: border_color; }

                    if selected_json_path != "": Text {
                        text: "è·¯å¾„: " + selected_json_path;
                        font-size: 12px;
                        font-family: terminal_font;
                        color: accent_color;
                    }

                    // ä¸ŠåŠåŒºï¼šåŒ¹é…é¡¹åˆ—è¡¨ï¼ˆå¯æ»šåŠ¨ï¼‰
                    ScrollView {
                        ListView {
                            for item in search_results : Rectangle {
                                height: 28px;
                                background: background_secondary;

                                // ä¼˜åŒ–ï¼šä¸ºæœç´¢ç»“æœé¡¹å¯ç”¨æ¸²æŸ“ç¼“å­˜
                                cache-rendering-hint: true;
                                HorizontalLayout {
                                    padding-left: 6px;
                                    spacing: 6px;
                                    Text { text: item.kind + ":"; color: text_secondary; font-size: 11px; }
                                    Text { text: item.path; color: text_primary; font-size: 12px; }
                                }
                                TouchArea { clicked => { search_item_selected(item.path); } }
                            }
                        }
                    }

                    Rectangle { height: 1px; background: border_color; }

                    // ä¸‹åŠåŒºï¼šä¸­é—´äº§ç‰© ç¬¬äºŒé˜¶æ®µï¼ˆç”±â€œç”Ÿæˆä¸­é—´äº§ç‰©2â€äº§ç”Ÿï¼‰
                    HorizontalLayout {
                        spacing: panel_spacing;
                        alignment: space-between;
                        Text { text: "ä¸­é—´äº§ç‰© ç¬¬äºŒé˜¶æ®µ"; font-size: 12px; color: text_muted; }
                        if preview_total_pages > 1: HorizontalLayout {
                            spacing: 4px;
                            Button {
                                text: "ä¸Šä¸€é¡µ";
                                height: 24px;
                                enabled: preview_current_page > 1;
                                clicked => { preview_page_changed(preview_current_page - 1); }
                            }
                            Text {
                                text: preview_current_page + "/" + preview_total_pages;
                                font-size: 11px;
                                color: text_secondary;
                                vertical-alignment: center;
                            }
                            Button {
                                text: "ä¸‹ä¸€é¡µ";
                                height: 24px;
                                enabled: preview_current_page < preview_total_pages;
                                clicked => { preview_page_changed(preview_current_page + 1); }
                            }
                        }
                    }
                    ScrollView {
                        min-height: 180px;
                        Rectangle {
                            background: background_primary;
                            border-width: 1px;
                            border-color: border_color;
                            border-radius: 2px;

                            VerticalLayout {
                                padding: 8px;

                                Text {
                                    text: preview_text;
                                    font-size: 12px;
                                    font-family: terminal_font;
                                    color: text_primary;
                                    wrap: word-wrap;
                                }
                            }
                        }
                    }

                    Rectangle { height: 1px; background: border_color; }

                    // ä¸­é—´äº§ç‰© ç¬¬ä¸‰é˜¶æ®µï¼ˆè½¬æ¢ä¸ºæœ€ç»ˆç»“æœï¼‰
                    HorizontalLayout {
                        spacing: panel_spacing;
                        alignment: space-between;
                        Text { text: "æœ€ç»ˆäº§ç‰©"; font-size: 12px; color: text_muted; }
                        if final_total_pages > 1: HorizontalLayout {
                            spacing: 4px;
                            Button {
                                text: "ä¸Šä¸€é¡µ";
                                height: 24px;
                                enabled: final_current_page > 1;
                                clicked => { final_page_changed(final_current_page - 1); }
                            }
                            Text {
                                text: final_current_page + "/" + final_total_pages;
                                font-size: 11px;
                                color: text_secondary;
                                vertical-alignment: center;
                            }
                            Button {
                                text: "ä¸‹ä¸€é¡µ";
                                height: 24px;
                                enabled: final_current_page < final_total_pages;
                                clicked => { final_page_changed(final_current_page + 1); }
                            }
                        }
                    }
                    ScrollView {
                        min-height: 120px;
                        Rectangle {
                            background: background_primary;
                            border-width: 1px;
                            border-color: border_color;
                            border-radius: 2px;

                            VerticalLayout {
                                padding: 8px;

                                Text {
                                    text: final_product_text;
                                    font-size: 12px;
                                    font-family: terminal_font;
                                    color: text_primary;
                                    wrap: word-wrap;
                                }
                            }
                        }
                    }
                }
            }

            // === å³ä¾§ï¼šç²˜è´´ä¸å›å†™åŒº ===
            Rectangle {
                width: 42%;
                background: background_secondary;
                border-width: 1px;
                border-color: border_color;
                border-radius: 4px;

                VerticalLayout {
                    padding: content_padding;
                    spacing: panel_spacing;

                    VerticalLayout {
                        spacing: 8px;

                        HorizontalLayout {
                            spacing: 8px;
                            TerminalButton {
                                text: "ä¸Šä¼ å›å†™æ–‡ä»¶";
                                height: button_height;
                                clicked => { upload_writeback_file(); }
                            }
                            TerminalButton {
                                text: "ä¿å­˜ä¿®æ”¹";
                                height: button_height;
                                enabled: paste_text != "";
                                clicked => { save_modified_json(); }
                            }
                            TerminalButton {
                                text: "å›å†™";
                                height: button_height;
                                enabled: paste_text != "" && selected_json_path != "";
                                clicked => { write_back_pressed(); }
                            }
                        }
                    }

                    Rectangle {
                        height: 1px;
                        background: border_color;
                    }

                    VerticalLayout {
                        spacing: 8px;

                        HorizontalLayout {
                            spacing: 8px;
                            alignment: space-between;

                            Text {
                                text: "å›å†™æ—¥å¿—";
                                font-size: 14px;
                                font-family: terminal_font;
                                font-weight: 600;
                                color: accent_color;
                            }

                            HorizontalLayout {
                                spacing: 4px;

                                TerminalButton {
                                    text: "æµ‹è¯•æ—¥å¿—";
                                    height: 24px;
                                    clicked => {
                                        writeback_log = "[æµ‹è¯•] è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ—¥å¿—\n" + writeback_log;
                                    }
                                }

                                TerminalButton {
                                    text: "æ¸…ç©ºæ—¥å¿—";
                                    height: 24px;
                                    clicked => { clear_writeback_log(); }
                                }
                            }
                        }

                        ScrollView {
                            min-height: 180px;
                            // max-height: 100;
                            viewport-height: log_text.preferred-height;
                            vertical-scrollbar-policy: ScrollBarPolicy.as-needed;
                            horizontal-scrollbar-policy: ScrollBarPolicy.as-needed;

                            Rectangle {
                                background: #1a1a1a;
                                border-radius: 2px;

                                log_text := Text {
                                    text: writeback_log;
                                    font-size: 11px;
                                    wrap: TextWrap.word-wrap;
                                    color: #00ff00;
                                    vertical-alignment: top;
                                    horizontal-alignment: left;
                                    width: parent.width;
                                    x: 8px;
                                    y: 8px;
                                }
                            }
                        }
                    }
                }
            }
        }

        // === åº•éƒ¨çŠ¶æ€æ  ===
        Rectangle {
            height: status_height;
            background: background_tertiary;
            border-width: 1px;
            border-color: border_color;

            HorizontalLayout {
                padding-left: content_padding;
                padding-right: content_padding;
                spacing: 12px;
                alignment: start;

                // å·¦ä¾§ï¼šçŠ¶æ€æ¶ˆæ¯
                Text {
                    text: "çŠ¶æ€: " + status_message + " â–ˆ [è¿›åº¦:" + (progress_visible ? "æ˜¾ç¤º" : "éšè—") + "]";
                    font-size: 12px;
                    font-family: terminal_font;
                    color: accent_color;
                    vertical-alignment: center;
                    horizontal-stretch: 0;
                }

                // ä¸­é—´ï¼šè¿›åº¦æ¡åŒºåŸŸï¼ˆä½¿ç”¨æ ‡å‡†ProgressIndicatorç»„ä»¶ï¼‰
                HorizontalLayout {
                    width: 280px;
                    height: parent.height;
                    spacing: 8px;
                    alignment: center;
                    padding-top: 6px;
                    padding-bottom: 6px;
                    visible: progress_visible;  // ä½¿ç”¨ visible å±æ€§è€Œä¸æ˜¯æ¡ä»¶æ¸²æŸ“

                    Text {
                        text: progress_text;
                        font-size: 11px;
                        font-family: terminal_font;
                        color: text_primary;
                        vertical-alignment: center;
                        max-width: 120px;
                    }

                    ProgressIndicator {
                        progress: progress_value;
                        width: 100px;
                        height: 12px;
                    }

                    Text {
                        text: Math.round(progress_value * 100) + "%";
                        font-size: 11px;
                        font-family: terminal_font;
                        color: text_secondary;
                        vertical-alignment: center;
                        width: 35px;
                    }
                }

                // å³ä¾§ï¼šæ€§èƒ½ä¿¡æ¯ï¼ˆè‡ªåŠ¨å¡«å……å‰©ä½™ç©ºé—´ï¼‰
                Text {
                    text: performance_info != "" ? "| " + performance_info + " | UTF-8" : "| UTF-8";
                    font-size: 11px;
                    font-family: terminal_font;
                    color: text_tertiary;
                    vertical-alignment: center;
                    horizontal-stretch: 1;
                    horizontal-alignment: right;
                }
            }
        }
    }
}